#!/bin/bash
# 安装用户配置文件和插件脚本
# 用于在编译后安装配置文件和插件到用户目录

# 检测实际用户（如果通过 sudo 运行，使用 SUDO_USER）
ACTUAL_USER="${SUDO_USER:-$USER}"
if [ "$ACTUAL_USER" = "root" ] && [ -n "$SUDO_USER" ]; then
    ACTUAL_USER="$SUDO_USER"
fi

# 获取实际用户的主目录
if [ "$ACTUAL_USER" = "root" ]; then
    # 如果是 root，尝试从环境变量获取
    if [ -n "$SUDO_USER" ]; then
        ACTUAL_USER="$SUDO_USER"
        HOME=$(eval echo ~$ACTUAL_USER)
    else
        # 如果没有 SUDO_USER，使用当前登录用户
        ACTUAL_USER=$(logname 2>/dev/null || echo "$USER")
        HOME=$(eval echo ~$ACTUAL_USER)
    fi
else
    HOME=$(eval echo ~$ACTUAL_USER)
fi

# 如果仍然无法确定，尝试从 /etc/passwd 获取
if [ ! -d "$HOME" ] || [ "$HOME" = "/root" ]; then
    # 尝试获取第一个非 root 用户的主目录
    for user in $(getent passwd | awk -F: '$3 >= 1000 && $1 != "nobody" {print $1}' | head -1); do
        if [ -n "$user" ]; then
            ACTUAL_USER="$user"
            HOME=$(eval echo ~$ACTUAL_USER)
            if [ -d "$HOME" ]; then
                break
            fi
        fi
    done
fi

echo "Detected user: $ACTUAL_USER"
echo "Home directory: $HOME"

# 配置文件和插件目标目录
CONFIG_DIR="$HOME/.config/pnana"
PLUGIN_DIR="$CONFIG_DIR/plugins"

echo "Installing configuration and plugins to user directory..."
echo "  Config directory: $CONFIG_DIR"
echo "  Plugin directory: $PLUGIN_DIR"

# 创建目录
if [ -n "$SUDO_USER" ] && [ "$USER" = "root" ]; then
    # 如果通过 sudo 运行，使用实际用户创建目录
    sudo -u "$ACTUAL_USER" mkdir -p "$CONFIG_DIR" 2>/dev/null || mkdir -p "$CONFIG_DIR"
    sudo -u "$ACTUAL_USER" mkdir -p "$PLUGIN_DIR" 2>/dev/null || mkdir -p "$PLUGIN_DIR"
    # 设置正确的所有者
    if [ -d "$CONFIG_DIR" ]; then
        chown -R "$ACTUAL_USER:$ACTUAL_USER" "$CONFIG_DIR" 2>/dev/null || true
    fi
else
    mkdir -p "$CONFIG_DIR"
    mkdir -p "$PLUGIN_DIR"
fi

# 安装默认配置文件
DEFAULT_CONFIG="@CMAKE_SOURCE_DIR@/config/default_config.json"
if [ -f "$DEFAULT_CONFIG" ]; then
    if [ -n "$SUDO_USER" ] && [ "$USER" = "root" ]; then
        sudo -u "$ACTUAL_USER" cp "$DEFAULT_CONFIG" "$CONFIG_DIR/config.json" 2>/dev/null || cp "$DEFAULT_CONFIG" "$CONFIG_DIR/config.json"
    else
        cp "$DEFAULT_CONFIG" "$CONFIG_DIR/config.json"
    fi
    echo "  ✓ Installed config: $CONFIG_DIR/config.json"
else
    echo "  ✗ Default config not found: $DEFAULT_CONFIG"
fi

# 安装插件
PLUGIN_SOURCE_DIR="@CMAKE_BINARY_DIR@/plugins"
if [ -d "$PLUGIN_SOURCE_DIR" ]; then
    # 复制所有插件（如果不存在则复制）
    for plugin in "$PLUGIN_SOURCE_DIR"/*; do
        if [ -d "$plugin" ]; then
            plugin_name=$(basename "$plugin")
            target_plugin="$PLUGIN_DIR/$plugin_name"

            # 排除隐藏目录和文档
            if [[ $plugin_name == .* ]] || [[ $plugin_name == CMakeLists.txt ]] || [[ $plugin_name == *.md ]]; then
                continue
            fi

            echo "  Installing plugin: $plugin_name"

            # 如果目标目录已存在，先删除它以避免嵌套目录问题
            if [ -d "$target_plugin" ]; then
                if [ -n "$SUDO_USER" ] && [ "$USER" = "root" ]; then
                    sudo -u "$ACTUAL_USER" rm -rf "$target_plugin" 2>/dev/null || rm -rf "$target_plugin"
                else
                    rm -rf "$target_plugin"
                fi
            fi

            if [ -n "$SUDO_USER" ] && [ "$USER" = "root" ]; then
                # 如果通过 sudo 运行，使用实际用户复制
                sudo -u "$ACTUAL_USER" cp -r "$plugin" "$target_plugin" 2>/dev/null || cp -r "$plugin" "$target_plugin"
                chown -R "$ACTUAL_USER:$ACTUAL_USER" "$target_plugin" 2>/dev/null || true
            else
                cp -r "$plugin" "$target_plugin"
            fi
        fi
    done
    echo "  ✓ Plugins installed to: $PLUGIN_DIR"
else
    echo "  ✗ Plugin source directory not found: $PLUGIN_SOURCE_DIR"
fi

echo "Installation completed successfully!"
echo "Configuration: $CONFIG_DIR/config.json"
echo "Plugins: $PLUGIN_DIR"
